<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizer</title>
  <meta name="theme-color" content="#000000" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Visualizer" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
    }

    .background {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 0;
    }
    .star {
      position: absolute;
      background-color: #fff;
      border-radius: 50%;
      opacity: 0;
      animation: twinkle 4s infinite ease-in-out alternate;
    }
    @keyframes twinkle {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.5); }
    }

    .ui {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 2;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 10px;
      max-height: 95vh;
      overflow-y: auto;
    }
    canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
    }
    label, input, button, select {
      display: block;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="background"></div>
  <canvas id="visualizer"></canvas>
  <div class="ui">
    <label for="audioFile">音声ファイルを選択</label>
    <input type="file" id="audioFile" accept="audio/*">
    <button id="rainbowToggle">レインボーモード: OFF</button>
    <input type="color" id="colorPicker" value="#ffffff">
    <select id="visualizerType">
      <option value="bars">棒グラフ</option>
      <option value="wave">波形</option>
    </select>
    <label>音量
      <input type="range" id="volume" min="0" max="2" step="0.01" value="1">
    </label>
  </div>
  <script>
    // 背景アニメーション
    const background = document.querySelector('.background');
    for (let i = 0; i < 100; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * 3 + 1;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.top = `${Math.random() * 100}%`;
      star.style.left = `${Math.random() * 100}%`;
      star.style.animationDelay = `${Math.random() * 4}s`;
      background.appendChild(star);
    }

    // オーディオ & ビジュアライザー
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const audioFile = document.getElementById('audioFile');
    const rainbowToggle = document.getElementById('rainbowToggle');
    const colorPicker = document.getElementById('colorPicker');
    const visualizerType = document.getElementById('visualizerType');
    const volumeSlider = document.getElementById('volume');

    let rainbow = false;
    let color = '#ffffff';
    let type = 'bars';

    rainbowToggle.onclick = () => {
      rainbow = !rainbow;
      rainbowToggle.textContent = rainbow ? 'レインボーモード: ON' : 'レインボーモード: OFF';
    };

    colorPicker.oninput = e => color = e.target.value;
    visualizerType.onchange = e => type = e.target.value;

    let audioContext, source, gainNode, analyser, dataArray;

    audioFile.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (audioContext) audioContext.close();

      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      gainNode = audioContext.createGain();
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      const audio = document.createElement('audio');
      audio.src = URL.createObjectURL(file);
      audio.crossOrigin = 'anonymous';
      audio.loop = true;
      await audio.play();

      source = audioContext.createMediaElementSource(audio);
      source.connect(gainNode);
      gainNode.connect(analyser);
      analyser.connect(audioContext.destination);

      volumeSlider.oninput = () => gainNode.gain.value = parseFloat(volumeSlider.value);

      draw();
    };

    function draw() {
      requestAnimationFrame(draw);
      if (!analyser) return;
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const len = dataArray.length;

      if (type === 'bars') {
        const barWidth = canvas.width / len;
        for (let i = 0; i < len; i++) {
          const val = dataArray[i];
          const hue = (Date.now() / 10 + i * 4) % 360;
          ctx.fillStyle = rainbow ? `hsl(${hue},100%,50%)` : color;
          ctx.fillRect(i * barWidth, canvas.height - val, barWidth - 2, val);
        }
      } else if (type === 'wave') {
        ctx.beginPath();
        const sliceWidth = canvas.width / len;
        for (let i = 0; i < len; i++) {
          const y = (dataArray[i] / 255) * canvas.height;
          if (i === 0) ctx.moveTo(i * sliceWidth, y);
          else ctx.lineTo(i * sliceWidth, y);
        }
        const hue = (Date.now() / 10) % 360;
        ctx.strokeStyle = rainbow ? `hsl(${hue},100%,50%)` : color;
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }
  </script>
</body>
</html>
